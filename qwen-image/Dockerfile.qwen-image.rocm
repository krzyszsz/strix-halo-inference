ARG ROCM_BASE=rocm/pytorch:rocm7.2_ubuntu24.04_py3.12_pytorch_release_2.9.1
FROM ${ROCM_BASE}

ENV DEBIAN_FRONTEND=noninteractive \
    HF_HOME=/mnt/hf \
    TRANSFORMERS_CACHE=/mnt/hf \
    HF_HUB_ENABLE_HF_TRANSFER=1 \
    PYTHONUNBUFFERED=1 \
    MODEL_ID=Qwen/Qwen-Image \
    DTYPE=float16

RUN apt-get update && apt-get install -y --no-install-recommends \
    git ca-certificates ffmpeg libgl1 \
 && rm -rf /var/lib/apt/lists/*

RUN python -m pip install -U pip setuptools wheel
RUN python -m pip install -U \
  "huggingface_hub[cli]" \
  "fastapi>=0.110" "uvicorn[standard]>=0.27" \
  pillow opencv-python
RUN python -m pip install -U \
  "transformers>=4.45.0,<5" "accelerate>=0.33.0" safetensors sentencepiece protobuf
RUN python -m pip install -U "git+https://github.com/huggingface/diffusers"

WORKDIR /app
COPY app.py /app/app.py
COPY run.sh /app/run.sh
RUN chmod +x /app/run.sh

EXPOSE 8000
ENTRYPOINT ["/app/run.sh"]
